<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>ãŠã»ã‹ãŸã™ã‹ã— - ã‚¯ã‚¤ã‚º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <head>
    <meta charset="UTF-8">
    <title>ãŠã»ã‹ãŸã™ã‹ã— - ã‚¯ã‚¤ã‚º</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/quiz.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/admin-ranking.css') }}">
  </head>

<body>
  <div class="top-bar">
    ã‚°ãƒ«ãƒ¼ãƒ— <strong>{{ group_name }}</strong> <small>({{ group }})</small> / ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ <strong>{{ player }}</strong>
  </div>
  <div class="main-container">
    <div id="main">
      <p class="waiting">é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>
    </div>
  </div>

  <div id="modal">
    <div id="modal-content">
      <p class="werewolf-title">ğŸº ã‚ãªãŸã¯äººç‹¼ ğŸº</p>
      <p>æ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
      <button class="btn btn-primary" onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    const group = "{{ group }}";
    const player = "{{ player }}";
    let answered = false;
    let roleChecked = false;

    let lastStatus = null;
    let lastAnswered = null;

    function getFilteredRanking(rankingData) {
      if (!rankingData) return [];

      // Assign rank to each item
      const rankingWithRank = rankingData.map((item, index) => {
        return { ...item, rank: index + 1 };
      });

      if (rankingWithRank.length <= 5) return rankingWithRank;

      const myIndex = rankingWithRank.findIndex(r => r.id === group);
      const count = rankingWithRank.length;

      const indicesToShow = new Set();
      // Top 2
      indicesToShow.add(0);
      if (count > 1) indicesToShow.add(1);

      // Bottom 2
      indicesToShow.add(count - 1);
      if (count > 1) indicesToShow.add(count - 2);

      // Self
      if (myIndex !== -1) indicesToShow.add(myIndex);

      const sortedIndices = Array.from(indicesToShow).sort((a, b) => a - b);
      return sortedIndices.map(i => rankingWithRank[i]);
    }

    setInterval(async () => {
      const res = await fetch(`/api/state?group=${group}&player=${player}`);
      const data = await res.json();

      // Check if state changed significantly
      const statusChanged = data.status !== lastStatus;
      const answeredChanged = data.answered !== lastAnswered;

      if (!statusChanged && !answeredChanged) {
        return;
      }

      lastStatus = data.status;
      lastAnswered = data.answered;

      if (!roleChecked && data.is_werewolf) {
        document.getElementById("modal").style.display = "flex";
        roleChecked = true;
      }

      if (data.answered) {
        document.getElementById("main").innerHTML = "<p>ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã™ã§ã«å›ç­”ã—ã¾ã—ãŸ</p>";
        return;
      }

      if (data.status === "waiting") {
        document.getElementById("main").innerHTML = '<p class="waiting">é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p>';
      }

      if (data.status === "answering") {
        let html = `<p class="question-text">${data.question}</p>`;

        if (data.is_werewolf) {
          html += `<p id="secret" onclick="this.remove()">
  æ­£è§£ï¼š${data.correct}<br>
  ï¼ˆã‚¿ãƒƒãƒ—ã§æ¶ˆãˆã¾ã™ï¼‰
</p>
`;
        }

        html += `
      <div class="bottom-action-bar">
        <input id="ans" class="input" type="number" step="any" placeholder="ç­”ãˆã‚’å…¥åŠ›">
        <button class="btn btn-success" onclick="send()">ç¢ºå®š</button>
      </div>
    `;
        document.getElementById("main").innerHTML = html;
      }

      if (data.status === "result") {
        let html = `
          <h2>æ­£è§£ç™ºè¡¨</h2>
          <table class="result-table">
            <tr><td>æ­£è§£</td><td>${data.correct}</td></tr>
            <tr><td>ä»Šå›ã‚¹ã‚³ã‚¢</td><td>${data.score}</td></tr>
            <tr><td>ç´¯ç©ã‚¹ã‚³ã‚¢</td><td>${data.total_score}</td></tr>
          </table>
        `;

        if (data.ranking) {
          html += "<h2>é †ä½è¡¨</h2>";
          html += "<div class='ranking-container'><table class='ranking-table'><thead><tr><th>é †ä½</th><th>ã‚°ãƒ«ãƒ¼ãƒ—</th><th>ç´¯ç©ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>";

          const filteredRanking = getFilteredRanking(data.ranking);
          const totalCount = data.ranking.length;

          for (let i = 0; i < filteredRanking.length; i++) {
            const r = filteredRanking[i];
            let rankClass = '';

            if (r.rank === 1) rankClass = 'rank-1';
            else if (r.rank === 2) rankClass = 'rank-2';
            else if (r.rank === totalCount) rankClass = 'rank-bottom';
            else if (r.rank === totalCount - 1) rankClass = 'rank-bottom-2';

            html += `<tr class="${rankClass}">
              <td>
                <span class="rank-badge">${r.rank}</span>
              </td>
              <td><strong>${r.group}</strong></td>
              <td>${r.score}</td>
            </tr>`;
          }
          html += "</tbody></table></div>";
        }

        document.getElementById("main").innerHTML = html;
        answered = false;
      }

      if (data.status === "ranking") {
        let html = "<h2>é †ä½è¡¨</h2>";
        html += "<table class='ranking-table'><thead><tr><th>é †ä½</th><th>ã‚°ãƒ«ãƒ¼ãƒ—</th><th>ç´¯ç©ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>";

        const filteredRanking = getFilteredRanking(data.ranking);
        const totalCount = data.ranking.length;

        for (let i = 0; i < filteredRanking.length; i++) {
          const r = filteredRanking[i];
          let rankClass = '';

          if (r.rank === 1) rankClass = 'rank-1';
          else if (r.rank === 2) rankClass = 'rank-2';
          else if (r.rank === totalCount) rankClass = 'rank-bottom';
          else if (r.rank === totalCount - 1) rankClass = 'rank-bottom-2';

          html += `<tr class="${rankClass}"><td>${r.rank}ä½</td><td><strong>${r.group}</strong></td><td>${r.score}</td></tr>`;
        }

        html += "</tbody></table>";
        main.innerHTML = html;
      }

    }, 1000);

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    async function send() {
      const v = ans.value;

      const res = await fetch("/api/answer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          group,
          answer: v
        })
      });

      if (!res.ok) {
        main.innerHTML = "ã™ã§ã«èª°ã‹ãŒå›ç­”ã—ã¦ã„ã¾ã™";
        lastAnswered = true;
        return;
      }

      main.innerHTML = "ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã™ã§ã«å›ç­”ã—ã¾ã—ãŸ";
      lastAnswered = true;
    }

  </script>
</body>

</html>