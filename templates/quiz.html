<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãŠãŠã‹ãŸã™ã‹ã— - ã‚¯ã‚¤ã‚º</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: "Space Grotesk", sans-serif;
  background: #f3f4f6;
  margin: 0;
  padding: 0;
}

.top-bar {
  width: 100%;
  background: white;
  color: #1f2937;
  padding: 16px 20px;
  text-align: center;
  font-weight: 600;
  font-size: 1em;
  border-bottom: 1px solid #e5e7eb;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

#main {
  max-width: 800px;
  margin: 40px auto;
  padding: 40px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
  min-height: 300px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

p {
  font-size: 1.1em;
  margin: 12px 0;
  color: #374151;
  line-height: 1.6;
}

input {
  font-size: 20px;
  padding: 12px 16px;
  width: 100%;
  max-width: 400px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
  transition: all 0.2s;
  background: white;
  color: #1f2937;
}

input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

input::placeholder {
  color: #9ca3af;
}

button {
  padding: 10px 24px;
  font-size: 15px;
  background: #3b82f6;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  margin: 8px;
  transition: all 0.2s;
}

button:hover {
  background: #2563eb;
}

button:active {
  transform: scale(0.98);
}

#modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(4px);
}

#modal-content {
  background: white;
  padding: 40px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
  max-width: 500px;
}

.werewolf {
  color: #dc2626;
  font-size: 2em;
  font-weight: 700;
  margin: 20px 0;
}

#secret {
  color: #dc2626;
  font-weight: 600;
  cursor: pointer;
  font-size: 1.2em;
  padding: 16px;
  background: #fef3c7;
  border-radius: 8px;
  display: inline-block;
  margin: 20px 0;
  user-select: none;
  border: 1px solid #fcd34d;
  transition: all 0.2s;
}

#secret:hover {
  background: #fde68a;
  transform: scale(1.02);
}

.result-table {
  width: 100%;
  margin: 20px 0;
  border-collapse: collapse;
}

.result-table td {
  padding: 12px;
  border-bottom: 1px solid #e5e7eb;
}

.result-table td:first-child {
  font-weight: 600;
  color: #3b82f6;
  text-align: right;
  width: 150px;
}

.result-table td:last-child {
  font-size: 1.2em;
  color: #1f2937;
  font-weight: 600;
}

.ranking-table {
  width: 100%;
  margin: 20px 0;
  border-collapse: collapse;
}

.ranking-table thead {
  background: #f3f4f6;
  border-bottom: 2px solid #e5e7eb;
}

.ranking-table th {
  padding: 12px 16px;
  text-align: left;
  font-weight: 600;
  color: #374151;
}

.ranking-table td {
  padding: 12px 16px;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
  color: #374151;
}

.ranking-table tr:hover {
  background: #f9fafb;
}

.ranking-table .rank-1 {
  background: #fef3c7;
  font-weight: 600;
}

.ranking-table .rank-2 {
  background: #dbeafe;
}

.ranking-table .rank-3 {
  background: #fce7f3;
}

.waiting {
  font-size: 1.3em;
  color: #6b7280;
  animation: pulse 1.5s infinite;
}

h2 {
  color: #1f2937;
  font-size: 1.8em;
  margin: 20px 0 30px;
  font-weight: 700;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}
</style>
</head>

<body>
<div class="top-bar">
  ã‚°ãƒ«ãƒ¼ãƒ— <strong>{{ group }}</strong> / ç•ªå· <strong>{{ player }}</strong>
</div>
<div id="main"><p class="waiting">é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦</p></div>

<div id="modal">
  <div id="modal-content">
    <p class="werewolf">ğŸº ã‚ãªãŸã¯äººç‹¼ ğŸº</p>
    <p>æ­£è§£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
    <button onclick="closeModal()">OK</button>
  </div>
</div>

<script>
const group = "{{ group }}";
const player = "{{ player }}";
let answered = false;
let roleChecked = false;

let lastStatus = null;
let lastAnswered = null;


setInterval(async () => {
  const res = await fetch(`/api/state?group=${group}&player=${player}`);
  const data = await res.json();
      if (data.answered) {
      document.getElementById("main").innerHTML =
        "<p>ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã™ã§ã«å›ç­”ã—ã¾ã—ãŸ</p>";
      return;
    }
  if (
  data.status === lastStatus
) {
  return;
}

lastStatus = data.status;
lastAnswered = data.answered;
  if (!roleChecked && data.is_werewolf) {
    document.getElementById("modal").style.display = "flex";
    roleChecked = true;
  }

  if (data.status === "answering") {
    let html = `<p style="font-size: 1.8em; font-weight: 600; margin-bottom: 30px; color: #1f2937;">${data.question}</p>`;

    if (data.is_werewolf) {
      html += `<p id="secret" onclick="this.remove()">
  æ­£è§£ï¼š${data.correct}<br>
  ï¼ˆã‚¿ãƒƒãƒ—ã§æ¶ˆãˆã¾ã™ï¼‰
</p>
`;
    }

    html += `
      <input id="ans" type="number" step="any" placeholder="ç­”ãˆã‚’å…¥åŠ›">
      <br>
      <button onclick="send()">é€ä¿¡</button>
    `;
    document.getElementById("main").innerHTML = html;
  }

  if (data.status === "result") {
    document.getElementById("main").innerHTML = `
      <h2>æ­£è§£ç™ºè¡¨</h2>
      <table class="result-table">
        <tr><td>æ­£è§£</td><td>${data.correct}</td></tr>
        <tr><td>ä»Šå›ã‚¹ã‚³ã‚¢</td><td>${data.score}</td></tr>
        <tr><td>ç´¯ç©ã‚¹ã‚³ã‚¢</td><td>${data.total_score}</td></tr>
      </table>
    `;
    answered = false;
  }

  if (data.status === "ranking") {
  let html = "<h2>é †ä½è¡¨</h2>";
  html += "<table class='ranking-table'><thead><tr><th>é †ä½</th><th>ã‚°ãƒ«ãƒ¼ãƒ—</th><th>ç´¯ç©ã‚¹ã‚³ã‚¢</th></tr></thead><tbody>";

  for (let i = 0; i < data.ranking.length; i++) {
    const r = data.ranking[i];
    let rankClass = '';
    if (i === 0) rankClass = 'rank-1';
    else if (i === 1) rankClass = 'rank-2';
    else if (i === 2) rankClass = 'rank-3';
    
    html += `<tr class="${rankClass}"><td>${i + 1}ä½</td><td><strong>${r.group}</strong></td><td>${r.score}</td></tr>`;
  }

  html += "</tbody></table>";
  main.innerHTML = html;
}

}, 3000);

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

async function send() {
  const v = ans.value;

  const res = await fetch("/api/answer", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      group,
      answer: v
    })
  });

  if (!res.ok) {
    main.innerHTML = "ã™ã§ã«èª°ã‹ãŒå›ç­”ã—ã¦ã„ã¾ã™";
    lastAnswered = true;   // â˜…è¿½åŠ 
    return;
  }

  main.innerHTML = "ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã™ã§ã«å›ç­”ã—ã¾ã—ãŸ";
  lastAnswered = true;     // â˜…è¿½åŠ 
}

</script>

</body>
</html>
